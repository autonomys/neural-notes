"use strict";(self.webpackChunkneural_notes=self.webpackChunkneural_notes||[]).push([[651],{4651:function(e,n,t){t.r(n),t.d(n,{ChatOpenAI:function(){return P}});var r=t(4165),o=t(7762),i=t(5861),a=t(1413),u=t(5671),l=t(3144),s=t(7326),c=t(136),d=t(9388),p=t(1469),v=t(1115),f=t(3399),m=t(8659),h=t(651);function y(e){var n,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Human",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"AI",i=[],a=(0,o.Z)(e);try{for(a.s();!(n=a.n()).done;){var u=n.value,l=void 0;if("human"===u._getType())l=t;else if("ai"===u._getType())l=r;else if("system"===u._getType())l="System";else{if("generic"!==u._getType())throw new Error("Got unsupported message type: ".concat(u));l=u.role}i.push("".concat(l,": ").concat(u.text))}}catch(s){a.e(s)}finally{a.f()}return i.join("\n")}var b=t(6738),g=function(e){(0,c.Z)(t,e);var n=(0,d.Z)(t);function t(e){return(0,u.Z)(this,t),n.call(this,e)}return(0,l.Z)(t,[{key:"generate",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(n,t,i){var a,u,l,s,c,d,p,v,f,h,g,O=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=[],l=[],s=n.map((function(e){return y(e)})),e.next=5,b.Ye.configure(i,this.callbacks,{verbose:this.verbose});case 5:return c=e.sent,e.next=8,null===c||void 0===c?void 0:c.handleLLMStart({name:this._llmType()},s);case 8:return d=e.sent,e.prev=9,e.next=12,Promise.all(n.map((function(e){return O._generate(e,t,d)})));case 12:p=e.sent,v=(0,o.Z)(p);try{for(v.s();!(f=v.n()).done;)(h=f.value).llmOutput&&l.push(h.llmOutput),u.push(h.generations)}catch(r){v.e(r)}finally{v.f()}e.next=22;break;case 17:return e.prev=17,e.t0=e.catch(9),e.next=21,null===d||void 0===d?void 0:d.handleLLMError(e.t0);case 21:throw e.t0;case 22:return g={generations:u,llmOutput:l.length?null===(a=this._combineLLMOutput)||void 0===a?void 0:a.call.apply(a,[this].concat(l)):void 0},e.next=25,null===d||void 0===d?void 0:d.handleLLMEnd(g);case 25:return Object.defineProperty(g,m.WH,{value:d?{runId:null===d||void 0===d?void 0:d.runId}:void 0,configurable:!0}),e.abrupt("return",g);case 27:case"end":return e.stop()}}),e,this,[[9,17]])})));return function(n,t,r){return e.apply(this,arguments)}}()},{key:"_modelType",value:function(){return"base_chat_model"}},{key:"generatePrompt",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(n,t,o){var i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.map((function(e){return e.toChatMessages()})),e.abrupt("return",this.generate(i,t,o));case 2:case"end":return e.stop()}}),e,this)})));return function(n,t,r){return e.apply(this,arguments)}}()},{key:"call",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(n,t,o){var i,a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generate([n],t,o);case 2:return i=e.sent,a=i.generations,e.abrupt("return",a[0][0].message);case 5:case"end":return e.stop()}}),e,this)})));return function(n,t,r){return e.apply(this,arguments)}}()},{key:"callPrompt",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(n,t,o){var i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.toChatMessages(),e.abrupt("return",this.call(i,t,o));case 2:case"end":return e.stop()}}),e,this)})));return function(n,t,r){return e.apply(this,arguments)}}()}]),t}(h.q),O=t(3834);function A(e){switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";default:throw new Error("Unknown message type: ".concat(e))}}function _(e,n){switch(e){case"user":return new m.Z(n);case"assistant":return new m.Ck(n);case"system":return new m.w(n);default:return new m.J(n,null!==e&&void 0!==e?e:"unknown")}}var P=function(e){(0,c.Z)(t,e);var n=(0,d.Z)(t);function t(e,r){var o,i,l,c,d,p,v,f,m,h,y,b,g,O,A,_,P,Z,w;(0,u.Z)(this,t),w=n.call(this,null!==e&&void 0!==e?e:{}),Object.defineProperty((0,s.Z)(w),"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty((0,s.Z)(w),"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty((0,s.Z)(w),"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty((0,s.Z)(w),"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty((0,s.Z)(w),"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty((0,s.Z)(w),"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty((0,s.Z)(w),"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty((0,s.Z)(w),"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty((0,s.Z)(w),"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});var k=null!==(o=null===e||void 0===e?void 0:e.openAIApiKey)&&void 0!==o?o:"undefined"!==typeof process?null===(i={NODE_ENV:"production",PUBLIC_URL:"/neural-notes",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0})||void 0===i?void 0:i.OPENAI_API_KEY:void 0,T=null!==(l=null===e||void 0===e?void 0:e.azureOpenAIApiKey)&&void 0!==l?l:"undefined"!==typeof process?null===(c={NODE_ENV:"production",PUBLIC_URL:"/neural-notes",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0})||void 0===c?void 0:c.AZURE_OPENAI_API_KEY:void 0;if(!T&&!k)throw new Error("(Azure) OpenAI API key not found");var E=null!==(d=null===e||void 0===e?void 0:e.azureOpenAIApiInstanceName)&&void 0!==d?d:"undefined"!==typeof process?null===(p={NODE_ENV:"production",PUBLIC_URL:"/neural-notes",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0})||void 0===p?void 0:p.AZURE_OPENAI_API_INSTANCE_NAME:void 0,I=null!==(v=null===e||void 0===e?void 0:e.azureOpenAIApiDeploymentName)&&void 0!==v?v:"undefined"!==typeof process?null===(f={NODE_ENV:"production",PUBLIC_URL:"/neural-notes",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0})||void 0===f?void 0:f.AZURE_OPENAI_API_DEPLOYMENT_NAME:void 0,S=null!==(m=null===e||void 0===e?void 0:e.azureOpenAIApiVersion)&&void 0!==m?m:"undefined"!==typeof process?null===(h={NODE_ENV:"production",PUBLIC_URL:"/neural-notes",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0})||void 0===h?void 0:h.AZURE_OPENAI_API_VERSION:void 0;if(w.modelName=null!==(y=null===e||void 0===e?void 0:e.modelName)&&void 0!==y?y:w.modelName,w.modelKwargs=null!==(b=null===e||void 0===e?void 0:e.modelKwargs)&&void 0!==b?b:{},w.timeout=null===e||void 0===e?void 0:e.timeout,w.temperature=null!==(g=null===e||void 0===e?void 0:e.temperature)&&void 0!==g?g:w.temperature,w.topP=null!==(O=null===e||void 0===e?void 0:e.topP)&&void 0!==O?O:w.topP,w.frequencyPenalty=null!==(A=null===e||void 0===e?void 0:e.frequencyPenalty)&&void 0!==A?A:w.frequencyPenalty,w.presencePenalty=null!==(_=null===e||void 0===e?void 0:e.presencePenalty)&&void 0!==_?_:w.presencePenalty,w.maxTokens=null===e||void 0===e?void 0:e.maxTokens,w.n=null!==(P=null===e||void 0===e?void 0:e.n)&&void 0!==P?P:w.n,w.logitBias=null===e||void 0===e?void 0:e.logitBias,w.stop=null===e||void 0===e?void 0:e.stop,w.streaming=null!==(Z=null===e||void 0===e?void 0:e.streaming)&&void 0!==Z&&Z,w.azureOpenAIApiVersion=S,w.azureOpenAIApiKey=T,w.azureOpenAIApiInstanceName=E,w.azureOpenAIApiDeploymentName=I,w.streaming&&w.n>1)throw new Error("Cannot stream results when n > 1");if(w.azureOpenAIApiKey){if(!w.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!w.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!w.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}return w.clientConfig=(0,a.Z)({apiKey:k},r),w}return(0,l.Z)(t,[{key:"invocationParams",value:function(){return(0,a.Z)({model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming},this.modelKwargs)}},{key:"_identifyingParams",value:function(){return(0,a.Z)((0,a.Z)({model_name:this.modelName},this.invocationParams()),this.clientConfig)}},{key:"identifyingParams",value:function(){return this._identifyingParams()}},{key:"_generate",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(n,t,i){var u,l,s,c,d,p,v,m,h,y,b,g,O,P,Z,w,k,T,E,I,S,N,C,x,K,R=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=Array.isArray(t)?t:null===t||void 0===t?void 0:t.stop,c=Array.isArray(t)?{}:null!==(u=null===t||void 0===t?void 0:t.options)&&void 0!==u?u:{},d={},!this.stop||!s){e.next=5;break}throw new Error("Stop found in input and default params");case 5:if((p=this.invocationParams()).stop=null!==s&&void 0!==s?s:p.stop,v=n.map((function(e){return{role:A(e._getType()),content:e.text,name:e.name}})),!p.stream){e.next=14;break}return e.next=11,new Promise((function(e,n){var t,r=!1,u=!1;R.completionWithRetry((0,a.Z)((0,a.Z)({},p),{},{messages:v}),(0,a.Z)((0,a.Z)({},c),{},{adapter:f.Z,responseType:"stream",onmessage:function(n){var r,a;if("[DONE]"===(null===(r=n.data)||void 0===r||null===(a=r.trim)||void 0===a?void 0:a.call(r))){if(u)return;u=!0,e(t)}else{var l=JSON.parse(n.data);t||(t={id:l.id,object:l.object,created:l.created,model:l.model,choices:[]});var s,c=(0,o.Z)(l.choices);try{var d=function(){var e=s.value;if(null!=e){var n,r,o,a,u,l,c,d,p=t.choices.find((function(n){return n.index===e.index}));if(!p)p={index:e.index,finish_reason:null!==(u=e.finish_reason)&&void 0!==u?u:void 0},t.choices[e.index]=p;if(!p.message)p.message={role:null===(l=e.delta)||void 0===l?void 0:l.role,content:null!==(c=null===(d=e.delta)||void 0===d?void 0:d.content)&&void 0!==c?c:""};p.message.content+=null!==(n=null===(r=e.delta)||void 0===r?void 0:r.content)&&void 0!==n?n:"",null===i||void 0===i||i.handleLLMNewToken(null!==(o=null===(a=e.delta)||void 0===a?void 0:a.content)&&void 0!==o?o:"")}};for(c.s();!(s=c.n()).done;)d()}catch(p){c.e(p)}finally{c.f()}!u&&l.choices.every((function(e){return null!=e.finish_reason}))&&(u=!0,e(t))}}})).catch((function(e){r||(r=!0,n(e))}))}));case 11:e.t0=e.sent,e.next=17;break;case 14:return e.next=16,this.completionWithRetry((0,a.Z)((0,a.Z)({},p),{},{messages:v}),c);case 16:e.t0=e.sent;case 17:m=e.t0,h=null!==(l=m.usage)&&void 0!==l?l:{},y=h.completion_tokens,b=h.prompt_tokens,g=h.total_tokens,y&&(d.completionTokens=(null!==(O=d.completionTokens)&&void 0!==O?O:0)+y),b&&(d.promptTokens=(null!==(P=d.promptTokens)&&void 0!==P?P:0)+b),g&&(d.totalTokens=(null!==(Z=d.totalTokens)&&void 0!==Z?Z:0)+g),w=[],k=(0,o.Z)(m.choices);try{for(k.s();!(T=k.n()).done;)C=T.value,x=null!==(E=null===(I=C.message)||void 0===I?void 0:I.role)&&void 0!==E?E:void 0,K=null!==(S=null===(N=C.message)||void 0===N?void 0:N.content)&&void 0!==S?S:"",w.push({text:K,message:_(x,K)})}catch(r){k.e(r)}finally{k.f()}return e.abrupt("return",{generations:w,llmOutput:{tokenUsage:d}});case 26:case"end":return e.stop()}}),e,this)})));return function(n,t,r){return e.apply(this,arguments)}}()},{key:"getNumTokensFromMessages",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(n){var t,o,a,u,l=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=0,o=0,a=0,"gpt-3.5-turbo"===(0,O._i)(this.modelName)?(o=4,a=-1):(0,O._i)(this.modelName).startsWith("gpt-4")&&(o=3,a=1),e.next=6,Promise.all(n.map(function(){var e=(0,i.Z)((0,r.Z)().mark((function e(n){var i,u;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.getNumTokens(n.text);case 2:return i=e.sent,u=i+o+(n.name?a:0),t+=u,e.abrupt("return",u);case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()));case 6:return u=e.sent,e.abrupt("return",{totalCount:t,countPerMessage:u});case 8:case"end":return e.stop()}}),e,this)})));return function(n){return e.apply(this,arguments)}}()},{key:"completionWithRetry",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(n,t){var o,i,u;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.client||(o=this.azureOpenAIApiKey?"https://".concat(this.azureOpenAIApiInstanceName,".openai.azure.com/openai/deployments/").concat(this.azureOpenAIApiDeploymentName):this.clientConfig.basePath,i=new v.Configuration((0,a.Z)((0,a.Z)({},this.clientConfig),{},{basePath:o,baseOptions:(0,a.Z)({timeout:this.timeout},this.clientConfig.baseOptions)})),this.client=new v.OpenAIApi(i)),u=(0,a.Z)((0,a.Z)({adapter:p.UG?void 0:f.Z},this.clientConfig.baseOptions),t),this.azureOpenAIApiKey&&(u.headers=(0,a.Z)({"api-key":this.azureOpenAIApiKey},u.headers),u.params=(0,a.Z)({"api-version":this.azureOpenAIApiVersion},u.params)),e.abrupt("return",this.caller.call(this.client.createChatCompletion.bind(this.client),n,u).then((function(e){return e.data})));case 4:case"end":return e.stop()}}),e,this)})));return function(n,t){return e.apply(this,arguments)}}()},{key:"_llmType",value:function(){return"openai"}},{key:"_combineLLMOutput",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return n.reduce((function(e,n){var t,r,o;n&&n.tokenUsage&&(e.tokenUsage.completionTokens+=null!==(t=n.tokenUsage.completionTokens)&&void 0!==t?t:0,e.tokenUsage.promptTokens+=null!==(r=n.tokenUsage.promptTokens)&&void 0!==r?r:0,e.tokenUsage.totalTokens+=null!==(o=n.tokenUsage.totalTokens)&&void 0!==o?o:0);return e}),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}]),t}(g)}}]);
//# sourceMappingURL=651.366ceed4.chunk.js.map